# DartHeavyLifting - Модуль отслеживания штанги и позы спортсмена

Модуль на Python для отслеживания положения суставов (коленей) и пути штанги во время выполнения упражнений. Предназначен для использования на прямых трансляциях с последующей интеграцией в Unreal Engine.

## Возможности

- ✅ Полное отслеживание позы через MediaPipe (33 ключевые точки)
- ✅ Визуализация полного скелета (торс, ноги, руки)
- ✅ Обнаружение и отслеживание пути штанги (по окружности сбоку)
- ✅ Расчет углов суставов коленей (как в примере)
- ✅ Визуализация в реальном времени (наложение скелета на видео)
- ✅ Отправка всех joints через UDP в формате JSON для Unreal Engine
- ✅ Поддержка работы с картой захвата и видео файлами для отладки

## Установка

### Стандартная установка
```bash
pip install -r requirements.txt
```

### Проблемы с установкой MediaPipe?

Если возникают ошибки при установке MediaPipe, скорее всего проблема в версии Python.

#### Быстрое решение для Windows:

1. **Проверьте версию Python:**
   ```bash
   python check_python.py
   ```

2. **Если Python 3.12+, установите Python 3.10:**
   
   **Вариант A: Автоматическая установка (рекомендуется)**
   ```bash
   # Запустите скрипт установки Python 3.10
   setup_python310.bat
   
   # Затем настройте проект
   quick_setup.bat
   ```
   
   **Вариант B: Ручная установка через winget**
   ```bash
   winget install Python.Python.3.10
   py -3.10 -m venv venv
   venv\Scripts\activate
   pip install -r requirements.txt
   ```
   
   **Вариант C: Через Python Launcher**
   ```bash
   # После установки Python 3.10 вручную:
   py -3.10 -m venv venv
   venv\Scripts\activate
   pip install -r requirements.txt
   ```

3. **Для других систем:** Используйте pyenv или conda (см. [INSTALL.md](INSTALL.md))

⚠️ **Важно:** MediaPipe требует Python 3.8-3.11 (рекомендуется 3.10)

Подробнее см. [INSTALL.md](INSTALL.md) и [INSTALL_PYTHON_WINDOWS.md](INSTALL_PYTHON_WINDOWS.md)

## Использование

### Запуск с камеры (карты захвата)
1. Убедитесь, что карта захвата подключена
2. При необходимости измените `CAMERA_ID` в `config.py` (обычно 0 или 1)
3. Запустите:
```bash
python main.py
```

### Запуск с видео файла для отладки

Есть два способа запустить с видео файлом:

#### Способ 1: Через аргумент командной строки (рекомендуется)
```bash
python main.py -v "путь/к/видео.mp4"
```
или
```bash
python main.py --video "путь/к/видео.mp4"
```

Примеры:
```bash
python main.py -v test_video.mp4
python main.py -v videos/workout.mp4
python main.py -v "C:/Videos/barbell_side_view.mp4"
```

#### Способ 2: Через config.py
1. Откройте `config.py`
2. Установите `DEBUG_VIDEO_PATH = "путь/к/вашему/видео.mp4"`
3. Запустите:
```bash
python main.py
```

**Примечание:** Если указан аргумент `-v` или `--video`, он имеет приоритет над `DEBUG_VIDEO_PATH` в config.py.

### Управление
- `q` - выход из программы
- `c` - очистить путь штанги

**Примечание:** При использовании видео файла программа автоматически остановится после завершения видео.

### Тестирование UDP отправки
Для проверки работы UDP отправки запустите тестовый получатель:
```bash
python test_udp_receiver.py
```
Затем запустите основной модуль. Тестовый скрипт будет выводить все получаемые данные в консоль.

## Структура проекта

- `main.py` - главный файл запуска
- `pose_tracker.py` - модуль отслеживания позы человека
- `barbell_tracker.py` - модуль отслеживания штанги
- `visualizer.py` - модуль визуализации
- `udp_sender.py` - модуль отправки данных через UDP
- `config.py` - конфигурация параметров

## Формат данных UDP

JSON отправляется на `UDP_HOST:UDP_PORT` (по умолчанию 127.0.0.1:5005):

```json
{
  "timestamp": 1234567890.123,
  "knee_positions": {
    "left_knee": [320, 480],
    "right_knee": [600, 480],
    "left_knee_angle": 145.5,
    "right_knee_angle": 150.2
  },
  "joints": {
    "0": [0.5, 0.3, 0.0],
    "1": [0.52, 0.31, 0.0],
    ...
    "33": [0.6, 0.8, 0.0]
  },
  "barbell_path": [
    {"x": 500.0, "y": 300.0, "timestamp": 1234567890.100},
    {"x": 502.0, "y": 298.0, "timestamp": 1234567890.120}
  ]
}
```

Где:
- `knee_positions` - координаты коленей в пикселях и углы сгибания
- `joints` - все 33 ключевые точки MediaPipe Pose в нормализованных координатах (0-1), включая x, y, z
- `barbell_path` - путь движения штанги с временными метками

## Настройка параметров

Все параметры настраиваются в файле `config.py`:
- `VIDEO_WIDTH`, `VIDEO_HEIGHT` - разрешение видео
- `TARGET_FPS` - целевой FPS
- `UDP_HOST`, `UDP_PORT` - адрес и порт для UDP отправки
- `CAMERA_ID` - ID камеры (0 для первой)
- `DEBUG_VIDEO_PATH` - путь к видео файлу для отладки (None = использовать камеру)
- `BARBELL_CIRCLE_MIN_RADIUS`, `BARBELL_CIRCLE_MAX_RADIUS` - диапазон радиусов для обнаружения штанги

## Требования

- Python 3.8+
- OpenCV 4.8+
- MediaPipe 0.10+
- NumPy 1.24+

## Логирование

Все логи сохраняются в файл `tracking.log` и выводятся в консоль.

